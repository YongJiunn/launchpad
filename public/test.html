<!DOCTYPE html>
<html>
  <head>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link
      href="https://gateway.pinata.cloud/ipfs/QmeqQqq7GLgaEr8cPcsqxRCe6ZyhoEc3AtPMqjyvoqsYoM?filename=app.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div style="height: 100vh; background-color: #323232">
      <button
        type="button"
        id="btnConnectWallet"
        class="preview-connect-wallet btn btn-primary"
        onclick="handleConnectWallet()"
      >
        Connect Wallet
      </button>
      <div class="preview-container">
        <div class="preview-content">
          <div class="preview-title"><span>default</span></div>
          <div class="preview-cover-image">
            <img
              src="https://gateway.pinata.cloud/ipfs/QmcJtvSabMfCYjQaRdcfUqVzewY8tFvhoHLMVPDH78manN"
              style="background-color: rgb(50, 50, 50); height: 100%"
            />
          </div>
          <div class="preview-price">
            <div style="display: inline-block; width: 100%; text-align: center">
              <button onclick="handleQuantity('decrement')">-</button
              ><input
                id="mint_qty"
                type="number"
                class="preview-mint-qty unselectable"
                disabled=""
                value="1"
              /><button onclick="handleQuantity('increment')">+</button>
            </div>
          </div>
          <button
            onclick="mintNft()"
            type="button"
            class="mintButton btn btn-primary"
          >
            Mint - <span id="totalMintCost">0</span> ICX
          </button>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/icon-sdk-js@latest/build/icon-sdk-js.web.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script>
      var IconService = window["icon-sdk-js"];
      var IconConverter = IconService.Converter;
      let perNftCost = 10;
      let walletAddress;
      const handleQuantity = (eventType) => {
        let inputElement = document.getElementById("mint_qty");
        let inputValue = parseInt(inputElement.value);
        if (eventType == "increment") {
          let max = 100;
          inputElement.value = inputValue == max ? max : inputValue + 1;
        } //decrement
        else {
          let min = 1;
          inputElement.value = inputValue == min ? min : inputValue - 1;
        }
      };

      const getSiteInfo = () => {
        var payload = {
          jsonrpc: "2.0",
          method: "icx_call",
          params: {
            to: "cx00448346e85e70308953efd20e68164ff027cf93",
            dataType: "call",
            data: {
              method: "getSiteInfo",
            },
          },
        };
      };

      const mintNft = () => {
        if (walletAddress == null) {
          alert("please connect your wallet");
          return;
        }
        let quantityToMint = parseInt(
          document.getElementById("mint_qty").value
        );
        var payload = {
          jsonrpc: "2.0",
          method: "icx_sendTransaction",
          id: 6639,
          params: {
            to: "cx00448346e85e70308953efd20e68164ff027cf93",
            from: "hxbd1375315c7732779edaa4c3903ffc9b93e82ca3",
            nid: "0x53",
            version: IconConverter.toHexNumber("3"),
            value: IconConverter.toHexNumber(
              quantityToMint * perNftCost * 10 ** 18
            ),
            timestamp: IconConverter.toHexNumber(new Date().getTime() * 1000),
            stepLimit: IconConverter.toHexNumber("2000000"),
            nonce: IconConverter.toHexNumber("1"),
            dataType: "call",
            data: {
              method: "mint",
              params: {
                _mintQuantity: IconConverter.toHexNumber("2"),
              },
            },
          },
        };

        ICONexRequest("REQUEST_JSON-RPC", payload);
      };

      const handleConnectWallet = async () => {
        let _walletAddress;
        if (walletAddress == null) {
          _walletAddress = await ICONexRequest("REQUEST_ADDRESS");
          document.getElementById("btnConnectWallet").innerText =
            _walletAddress == null || _walletAddress == "undefined"
              ? "Connect Wallet"
              : `Disconnect from ${_walletAddress}`;
        } else {
          document.getElementById("btnConnectWallet").innerText =
            "Connect Wallet";
          _walletAddress = null;
        }
        walletAddress = _walletAddress;
      };

      async function ICONexRequest(requestType, payload) {
        return new Promise((resolve, reject) => {
          function eventHandler(event) {
            const { payload } = event.detail;
            window.removeEventListener("ICONEX_RELAY_RESPONSE", eventHandler);
            resolve(payload);
          }
          window.addEventListener("ICONEX_RELAY_RESPONSE", eventHandler);

          window.dispatchEvent(
            new window.CustomEvent("ICONEX_RELAY_REQUEST", {
              detail: {
                type: requestType,
                payload,
              },
            })
          );
        });
      }
    </script>
  </body>
</html>
